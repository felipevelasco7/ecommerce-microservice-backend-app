name: "Canary Deployment Simple"

on:
  workflow_dispatch:
    inputs:
      service:
        description: "Service to deploy with canary strategy"
        required: true
        type: choice
        options:
          - api-gateway
          - user-service
          - product-service
          - payment-service
          - order-service
          - shipping-service
          - favourite-service
      image_tag:
        description: "Image tag to deploy"
        required: true
        default: "latest"
      canary_percentage:
        description: "Percentage of traffic (1-50)"
        required: true
        default: "10"

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'axiomatic-fiber-479102-k7' }}
  GCP_ZONE: us-central1-a
  GKE_CLUSTER: ecommerce-cluster
  REGISTRY: gcr.io
  USE_GKE_GCLOUD_AUTH_PLUGIN: True

jobs:
  canary-deploy:
    name: ðŸ¦ Canary Deployment
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ”‘ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ðŸ› ï¸ Setup gcloud and kubectl
      uses: google-github-actions/setup-gcloud@v2
      with:
        install_components: 'gke-gcloud-auth-plugin'
      
    - name: âš™ï¸ Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GCP_ZONE }} \
          --project ${{ env.GCP_PROJECT_ID }}
          
    - name: ðŸ“Š Validate Inputs
      run: |
        echo "ðŸ” Validating canary deployment inputs..."
        
        if [ "${{ github.event.inputs.canary_percentage }}" -lt 1 ] || [ "${{ github.event.inputs.canary_percentage }}" -gt 50 ]; then
          echo "âŒ Canary percentage must be between 1 and 50"
          exit 1
        fi
        
        echo "âœ… Inputs validated successfully"
        
    - name: ðŸ¦ Create Canary Deployment
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        CANARY_PERCENTAGE="${{ github.event.inputs.canary_percentage }}"
        
        echo "ðŸ¦ Creating canary deployment for $SERVICE..."
        
        # Check if main deployment exists
        if ! kubectl get deployment $SERVICE -n dev >/dev/null 2>&1; then
          echo "âš ï¸ Main deployment for $SERVICE not found. Available deployments:"
          kubectl get deployments -n dev
          echo "â„¹ï¸ Please run main CI/CD pipeline first to create base deployment"
          exit 1
        fi
        
        # Create canary deployment (simple approach - just scale and update)
        echo "ðŸ“¦ Scaling main deployment to make room for canary..."
        
        # Get current replicas
        CURRENT_REPLICAS=$(kubectl get deployment $SERVICE -n dev -o jsonpath='{.spec.replicas}')
        CANARY_REPLICAS=1
        STABLE_REPLICAS=$((CURRENT_REPLICAS - CANARY_REPLICAS))
        
        if [ "$STABLE_REPLICAS" -lt 1 ]; then
          STABLE_REPLICAS=1
          CANARY_REPLICAS=1
          echo "â„¹ï¸ Adjusting replicas: Stable=$STABLE_REPLICAS, Canary=$CANARY_REPLICAS"
        fi
        
        # Scale down main deployment temporarily
        kubectl scale deployment $SERVICE --replicas=$STABLE_REPLICAS -n dev
        
        # Create canary deployment by copying existing deployment and modifying
        IMAGE_FULL_PATH="${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$SERVICE:$IMAGE_TAG"
        echo "ðŸ—ï¸ Creating canary deployment with image: $IMAGE_FULL_PATH"
        
        # Create canary deployment using kubectl create (simpler approach)
        kubectl create deployment $SERVICE-canary -n dev --image="$IMAGE_FULL_PATH" --replicas=$CANARY_REPLICAS --dry-run=client -o yaml | \
        kubectl apply -f -
        
        # Add resource limits using kubectl set resources (simpler and safer)
        echo "ðŸ”§ Adding resource limits to canary deployment..."
        kubectl set resources deployment/$SERVICE-canary -n dev \
          --requests=memory=256Mi,cpu=100m \
          --limits=memory=512Mi,cpu=500m
        
        echo "âœ… Canary deployment created and configured successfully"
        
        echo "âœ… Canary deployment created successfully"
        
        # Check if canary deployment was created successfully
        if kubectl get deployment/$SERVICE-canary -n dev >/dev/null 2>&1; then
          echo "âœ… Canary deployment created"
          
          # Wait for canary to be ready with better error handling
          echo "â³ Waiting for canary deployment to be ready..."
          if ! kubectl rollout status deployment/$SERVICE-canary -n dev --timeout=180s; then
            echo "âš ï¸ Canary deployment taking longer than expected"
            echo "ðŸ“Š Checking canary deployment status:"
            kubectl describe deployment/$SERVICE-canary -n dev
            echo "ðŸ“Š Checking canary pods:"
            kubectl get pods -l app=$SERVICE-canary -n dev -o wide
            kubectl describe pods -l app=$SERVICE-canary -n dev
            
            # Try to get more info about why it's failing
            echo "ðŸ“Š Checking events:"
            kubectl get events -n dev --sort-by='.lastTimestamp' | tail -10
            
            # Don't fail immediately, continue to next step for diagnosis
            echo "âš ï¸ Canary deployment may have issues, but continuing for diagnosis..."
          else
            echo "âœ… Canary deployment ready"
          fi
        else
          echo "âŒ Failed to create canary deployment"
          exit 1
        fi
        
        echo "ðŸ“Š Current state:"
        kubectl get pods -l app=$SERVICE -n dev -o wide
        kubectl get deployments -n dev | grep $SERVICE
        
    - name: ðŸ§ª Test Canary
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        
        echo "ðŸ§ª Testing canary deployment..."
        
        # Wait for pods to stabilize with retries
        for i in {1..6}; do
          echo "ðŸ” Attempt $i: Checking canary pods..."
          
          CANARY_PODS=$(kubectl get pods -l app=$SERVICE-canary -n dev --field-selector=status.phase=Running --no-headers 2>/dev/null | wc -l)
          TOTAL_CANARY_PODS=$(kubectl get pods -l app=$SERVICE-canary -n dev --no-headers 2>/dev/null | wc -l)
          
          echo "ðŸ“Š Canary pods status: $CANARY_PODS running / $TOTAL_CANARY_PODS total"
          
          if [ "$CANARY_PODS" -gt 0 ]; then
            echo "âœ… Canary test passed - $CANARY_PODS canary pod(s) running"
            break
          elif [ "$i" -eq 6 ]; then
            echo "âŒ Canary test failed after 6 attempts"
            echo "ðŸ“Š Final pod status:"
            kubectl get pods -l app=$SERVICE-canary -n dev -o wide
            echo "ðŸ“Š Pod descriptions:"
            kubectl describe pods -l app=$SERVICE-canary -n dev
            
            # Don't exit 1, continue to cleanup
            echo "âš ï¸ Canary failed but continuing to cleanup..."
            break
          else
            echo "â³ Waiting 30 seconds before retry..."
            sleep 30
          fi
        done
        
    - name: âœ… Promote Canary
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        
        echo "âœ… Promoting canary to production..."
        
        # Update main deployment with canary image
        kubectl set image deployment/$SERVICE \
          $SERVICE=${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$SERVICE:$IMAGE_TAG \
          -n dev
          
        # Scale main deployment back to original size
        ORIGINAL_REPLICAS=$(kubectl get deployment $SERVICE-canary -n dev -o jsonpath='{.spec.replicas}')
        MAIN_REPLICAS=$((ORIGINAL_REPLICAS + 1))
        kubectl scale deployment $SERVICE --replicas=$MAIN_REPLICAS -n dev
        
        # Wait for main deployment rollout
        kubectl rollout status deployment/$SERVICE -n dev --timeout=300s
        
        # Clean up canary
        kubectl delete deployment $SERVICE-canary -n dev
        
        echo "ðŸŽ‰ Canary promotion completed successfully!"
        
    - name: ðŸ§¹ Cleanup Canary (if exists)
      if: always()
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        
        echo "ðŸ§¹ Cleaning up canary deployment..."
        
        # Clean up canary deployment if it exists
        if kubectl get deployment $SERVICE-canary -n dev >/dev/null 2>&1; then
          kubectl delete deployment $SERVICE-canary -n dev
          echo "âœ… Canary deployment cleaned up"
        else
          echo "â„¹ï¸ No canary deployment to clean up"
        fi
        
        # Ensure main service is properly scaled
        kubectl get deployment $SERVICE -n dev
        
    - name: ðŸ“Š Summary
      run: |
        echo "## ðŸ¦ Canary Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Service**: ${{ github.event.inputs.service }}" >> $GITHUB_STEP_SUMMARY
        echo "**Image**: ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ github.event.inputs.service }}:${{ github.event.inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
        echo "**Canary %**: ${{ github.event.inputs.canary_percentage }}%" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: âœ… Canary deployment completed and promoted successfully" >> $GITHUB_STEP_SUMMARY
name: üê¶ Canary Deployment (Simple)

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy with canary strategy'
        required: true
        type: choice
        options:
          - api-gateway
          - user-service
          - product-service
          - payment-service
          - order-service
          - shipping-service
          - favourite-service
      image_tag:
        description: 'Image tag to deploy'
        required: true
        default: 'latest'
      canary_percentage:
        description: 'Percentage of traffic (1-50)'
        required: true
        default: '10'

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'axiomatic-fiber-479102-k7' }}
  GCP_ZONE: us-central1-a
  GKE_CLUSTER: ecommerce-cluster
  REGISTRY: gcr.io
  USE_GKE_GCLOUD_AUTH_PLUGIN: True

jobs:
  canary-deploy:
    name: üê¶ Canary Deployment
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      
    - name: üîë Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: üõ†Ô∏è Setup gcloud and kubectl
      uses: google-github-actions/setup-gcloud@v2
      with:
        install_components: 'gke-gcloud-auth-plugin'
      
    - name: ‚öôÔ∏è Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GCP_ZONE }} \
          --project ${{ env.GCP_PROJECT_ID }}
          
    - name: üìä Validate Inputs
      run: |
        echo "üîç Validating canary deployment inputs..."
        
        if [ "${{ github.event.inputs.canary_percentage }}" -lt 1 ] || [ "${{ github.event.inputs.canary_percentage }}" -gt 50 ]; then
          echo "‚ùå Canary percentage must be between 1 and 50"
          exit 1
        fi
        
        echo "‚úÖ Inputs validated successfully"
        
    - name: üê¶ Create Canary Deployment
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        CANARY_PERCENTAGE="${{ github.event.inputs.canary_percentage }}"
        
        echo "üê¶ Creating canary deployment for $SERVICE..."
        
        # Check if main deployment exists
        if ! kubectl get deployment $SERVICE -n dev >/dev/null 2>&1; then
          echo "‚ö†Ô∏è Main deployment for $SERVICE not found. Available deployments:"
          kubectl get deployments -n dev
          echo "‚ÑπÔ∏è Please run main CI/CD pipeline first to create base deployment"
          exit 1
        fi
        
        # Create canary deployment (simple approach - just scale and update)
        echo "üì¶ Scaling main deployment to make room for canary..."
        
        # Get current replicas
        CURRENT_REPLICAS=$(kubectl get deployment $SERVICE -n dev -o jsonpath='{.spec.replicas}')
        CANARY_REPLICAS=1
        STABLE_REPLICAS=$((CURRENT_REPLICAS - CANARY_REPLICAS))
        
        if [ "$STABLE_REPLICAS" -lt 1 ]; then
          STABLE_REPLICAS=1
          CANARY_REPLICAS=1
          echo "‚ÑπÔ∏è Adjusting replicas: Stable=$STABLE_REPLICAS, Canary=$CANARY_REPLICAS"
        fi
        
        # Scale down main deployment temporarily
        kubectl scale deployment $SERVICE --replicas=$STABLE_REPLICAS -n dev
        
        # Create canary deployment with explicit YAML
        cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: $SERVICE-canary
  namespace: dev
  labels:
    app: $SERVICE-canary
    version: canary
spec:
  replicas: $CANARY_REPLICAS
  selector:
    matchLabels:
      app: $SERVICE-canary
  template:
    metadata:
      labels:
        app: $SERVICE-canary
        version: canary
    spec:
      containers:
      - name: $SERVICE
        image: ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$SERVICE:$IMAGE_TAG
        ports:
        - containerPort: 8080
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
EOF
        
        # Check if canary deployment was created successfully
        if kubectl get deployment/$SERVICE-canary -n dev >/dev/null 2>&1; then
          echo "‚úÖ Canary deployment created"
          
          # Wait for canary to be ready with better error handling
          echo "‚è≥ Waiting for canary deployment to be ready..."
          if ! kubectl rollout status deployment/$SERVICE-canary -n dev --timeout=180s; then
            echo "‚ö†Ô∏è Canary deployment taking longer than expected"
            echo "üìä Checking canary deployment status:"
            kubectl describe deployment/$SERVICE-canary -n dev
            echo "üìä Checking canary pods:"
            kubectl get pods -l app=$SERVICE-canary -n dev -o wide
            kubectl describe pods -l app=$SERVICE-canary -n dev
            
            # Try to get more info about why it's failing
            echo "üìä Checking events:"
            kubectl get events -n dev --sort-by='.lastTimestamp' | tail -10
            
            # Don't fail immediately, continue to next step for diagnosis
            echo "‚ö†Ô∏è Canary deployment may have issues, but continuing for diagnosis..."
          else
            echo "‚úÖ Canary deployment ready"
          fi
        else
          echo "‚ùå Failed to create canary deployment"
          exit 1
        fi
        
        echo "üìä Current state:"
        kubectl get pods -l app=$SERVICE -n dev -o wide
        kubectl get deployments -n dev | grep $SERVICE
        
    - name: üß™ Test Canary
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        
        echo "üß™ Testing canary deployment..."
        
        # Wait for pods to stabilize with retries
        for i in {1..6}; do
          echo "üîç Attempt $i: Checking canary pods..."
          
          CANARY_PODS=$(kubectl get pods -l app=$SERVICE-canary -n dev --field-selector=status.phase=Running --no-headers 2>/dev/null | wc -l)
          TOTAL_CANARY_PODS=$(kubectl get pods -l app=$SERVICE-canary -n dev --no-headers 2>/dev/null | wc -l)
          
          echo "üìä Canary pods status: $CANARY_PODS running / $TOTAL_CANARY_PODS total"
          
          if [ "$CANARY_PODS" -gt 0 ]; then
            echo "‚úÖ Canary test passed - $CANARY_PODS canary pod(s) running"
            break
          elif [ "$i" -eq 6 ]; then
            echo "‚ùå Canary test failed after 6 attempts"
            echo "üìä Final pod status:"
            kubectl get pods -l app=$SERVICE-canary -n dev -o wide
            echo "üìä Pod descriptions:"
            kubectl describe pods -l app=$SERVICE-canary -n dev
            
            # Don't exit 1, continue to cleanup
            echo "‚ö†Ô∏è Canary failed but continuing to cleanup..."
            break
          else
            echo "‚è≥ Waiting 30 seconds before retry..."
            sleep 30
          fi
        done
        
    - name: ‚úÖ Promote Canary
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        
        echo "‚úÖ Promoting canary to production..."
        
        # Update main deployment with canary image
        kubectl set image deployment/$SERVICE \
          $SERVICE=${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$SERVICE:$IMAGE_TAG \
          -n dev
          
        # Scale main deployment back to original size
        ORIGINAL_REPLICAS=$(kubectl get deployment $SERVICE-canary -n dev -o jsonpath='{.spec.replicas}')
        MAIN_REPLICAS=$((ORIGINAL_REPLICAS + 1))
        kubectl scale deployment $SERVICE --replicas=$MAIN_REPLICAS -n dev
        
        # Wait for main deployment rollout
        kubectl rollout status deployment/$SERVICE -n dev --timeout=300s
        
        # Clean up canary
        kubectl delete deployment $SERVICE-canary -n dev
        
        echo "üéâ Canary promotion completed successfully!"
        
    - name: üßπ Cleanup Canary (if exists)
      if: always()
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        
        echo "üßπ Cleaning up canary deployment..."
        
        # Clean up canary deployment if it exists
        if kubectl get deployment $SERVICE-canary -n dev >/dev/null 2>&1; then
          kubectl delete deployment $SERVICE-canary -n dev
          echo "‚úÖ Canary deployment cleaned up"
        else
          echo "‚ÑπÔ∏è No canary deployment to clean up"
        fi
        
        # Ensure main service is properly scaled
        kubectl get deployment $SERVICE -n dev
        
    - name: üìä Summary
      run: |
        echo "## üê¶ Canary Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Service**: ${{ github.event.inputs.service }}" >> $GITHUB_STEP_SUMMARY
        echo "**Image**: ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ github.event.inputs.service }}:${{ github.event.inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
        echo "**Canary %**: ${{ github.event.inputs.canary_percentage }}%" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: ‚úÖ Canary deployment completed and promoted successfully" >> $GITHUB_STEP_SUMMARY
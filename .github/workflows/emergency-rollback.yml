name: âš¡ Emergency Rollback Pipeline

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to rollback'
        required: true
        type: choice
        options:
          - all
          - api-gateway
          - user-service
          - product-service
          - payment-service
          - order-service
          - shipping-service
          - favourite-service
      rollback_type:
        description: 'Type of rollback to perform'
        required: true
        type: choice
        options:
          - previous-version
          - specific-version
          - last-known-good
      specific_version:
        description: 'Specific version to rollback to (if rollback_type is specific-version)'
        required: false
        type: string
      reason:
        description: 'Reason for emergency rollback'
        required: true
        type: string

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'axiomatic-fiber-479102-k7' }}
  GCP_ZONE: us-central1-a
  GKE_CLUSTER: ecommerce-cluster
  REGISTRY: gcr.io
  USE_GKE_GCLOUD_AUTH_PLUGIN: True

jobs:
  # ðŸš¨ Pre-Rollback Validation
  pre-rollback-validation:
    name: ðŸš¨ Pre-Rollback Validation
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.determine-services.outputs.services }}
      rollback-approved: ${{ steps.validate.outputs.approved }}
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”‘ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ðŸ› ï¸ Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      
    - name: ðŸ”§ Install GKE Auth Plugin
      run: |
        gcloud components install gke-gcloud-auth-plugin
        export USE_GKE_GCLOUD_AUTH_PLUGIN=True
      
    - name: âš™ï¸ Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GCP_ZONE }} \
          --project ${{ env.GCP_PROJECT_ID }}

    - name: ðŸ“‹ Determine Services to Rollback
      id: determine-services
      run: |
        if [ "${{ github.event.inputs.service }}" == "all" ]; then
          SERVICES='["api-gateway", "user-service", "product-service", "payment-service", "order-service", "shipping-service", "favourite-service"]'
        else
          SERVICES='["${{ github.event.inputs.service }}"]'
        fi
        echo "services=$SERVICES" >> $GITHUB_OUTPUT
        echo "Services to rollback: $SERVICES"

    - name: ðŸ” Validate Current State
      id: validate
      run: |
        echo "ðŸ” Validating current cluster state..."
        
        # Check cluster connectivity
        if ! kubectl cluster-info >/dev/null 2>&1; then
          echo "âŒ Cannot connect to cluster"
          echo "approved=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Validate specific version if provided
        if [ "${{ github.event.inputs.rollback_type }}" == "specific-version" ] && [ -z "${{ github.event.inputs.specific_version }}" ]; then
          echo "âŒ Specific version required but not provided"
          echo "approved=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ… Pre-rollback validation passed"
        echo "approved=true" >> $GITHUB_OUTPUT

    - name: ðŸ“Š Log Rollback Request
      run: |
        echo "ðŸš¨ EMERGENCY ROLLBACK REQUEST"
        echo "Timestamp: $(date -u)"
        echo "Requested by: ${{ github.actor }}"
        echo "Service(s): ${{ github.event.inputs.service }}"
        echo "Rollback type: ${{ github.event.inputs.rollback_type }}"
        echo "Specific version: ${{ github.event.inputs.specific_version }}"
        echo "Reason: ${{ github.event.inputs.reason }}"
        echo "Run ID: ${{ github.run_id }}"

  # ðŸ”„ Execute Rollback
  execute-rollback:
    name: ðŸ”„ Rollback ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: pre-rollback-validation
    if: needs.pre-rollback-validation.outputs.rollback-approved == 'true'
    strategy:
      matrix:
        service: ${{ fromJson(needs.pre-rollback-validation.outputs.services) }}
      fail-fast: false
      max-parallel: 3
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”‘ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ðŸ› ï¸ Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      
    - name: âš™ï¸ Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GCP_ZONE }} \
          --project ${{ env.GCP_PROJECT_ID }}

    - name: ðŸ” Determine Rollback Target
      id: rollback-target
      run: |
        SERVICE="${{ matrix.service }}"
        ROLLBACK_TYPE="${{ github.event.inputs.rollback_type }}"
        
        echo "ðŸ” Determining rollback target for $SERVICE..."
        
        case "$ROLLBACK_TYPE" in
          "previous-version")
            # Get previous version from deployment history
            CURRENT_REVISION=$(kubectl rollout history deployment/$SERVICE -n dev | tail -n 1 | awk '{print $1}')
            PREVIOUS_REVISION=$((CURRENT_REVISION - 1))
            
            if [ "$PREVIOUS_REVISION" -lt 1 ]; then
              echo "âŒ No previous version available for $SERVICE"
              exit 1
            fi
            
            echo "target_type=revision" >> $GITHUB_OUTPUT
            echo "target_value=$PREVIOUS_REVISION" >> $GITHUB_OUTPUT
            echo "Target: Previous revision ($PREVIOUS_REVISION)"
            ;;
            
          "specific-version")
            SPECIFIC_VERSION="${{ github.event.inputs.specific_version }}"
            
            # Verify the image exists
            if ! gcloud container images list-tags ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$SERVICE --filter="tags=$SPECIFIC_VERSION" --format="get(tags)" | grep -q "$SPECIFIC_VERSION"; then
              echo "âŒ Specified version $SPECIFIC_VERSION not found for $SERVICE"
              exit 1
            fi
            
            echo "target_type=image" >> $GITHUB_OUTPUT
            echo "target_value=${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$SERVICE:$SPECIFIC_VERSION" >> $GITHUB_OUTPUT
            echo "Target: Specific version ($SPECIFIC_VERSION)"
            ;;
            
          "last-known-good")
            # Find last known good version (this would typically come from monitoring/health checks)
            # For now, we'll use the version from 24 hours ago or previous stable tag
            STABLE_TAG=$(gcloud container images list-tags ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$SERVICE --filter="tags:stable OR tags:prod" --limit=1 --format="get(tags[0])" || echo "")
            
            if [ -z "$STABLE_TAG" ]; then
              echo "âŒ No stable version found for $SERVICE"
              exit 1
            fi
            
            echo "target_type=image" >> $GITHUB_OUTPUT
            echo "target_value=${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$SERVICE:$STABLE_TAG" >> $GITHUB_OUTPUT
            echo "Target: Last known good ($STABLE_TAG)"
            ;;
        esac

    - name: ðŸš¨ Execute Emergency Rollback
      run: |
        SERVICE="${{ matrix.service }}"
        TARGET_TYPE="${{ steps.rollback-target.outputs.target_type }}"
        TARGET_VALUE="${{ steps.rollback-target.outputs.target_value }}"
        
        echo "ðŸš¨ Executing emergency rollback for $SERVICE..."
        echo "Target Type: $TARGET_TYPE"
        echo "Target Value: $TARGET_VALUE"
        
        # Record current state before rollback
        kubectl get deployment $SERVICE -n dev -o yaml > /tmp/pre-rollback-$SERVICE.yaml
        
        case "$TARGET_TYPE" in
          "revision")
            echo "ðŸ”„ Rolling back to revision $TARGET_VALUE..."
            kubectl rollout undo deployment/$SERVICE -n dev --to-revision=$TARGET_VALUE
            ;;
          "image")
            echo "ðŸ”„ Rolling back to image $TARGET_VALUE..."
            kubectl set image deployment/$SERVICE $SERVICE=$TARGET_VALUE -n dev
            ;;
        esac
        
        echo "â³ Waiting for rollback to complete..."
        kubectl rollout status deployment/$SERVICE -n dev --timeout=300s
        
        echo "âœ… Rollback completed for $SERVICE"

    - name: ðŸ©º Post-Rollback Health Check
      run: |
        SERVICE="${{ matrix.service }}"
        
        echo "ðŸ©º Running post-rollback health checks for $SERVICE..."
        
        # Wait for pods to be ready
        kubectl wait --for=condition=ready pod -l app=$SERVICE -n dev --timeout=300s
        
        # Get service endpoint
        SERVICE_IP=$(kubectl get svc $SERVICE -n dev -o jsonpath='{.spec.clusterIP}')
        
        # Test health endpoint
        for i in {1..5}; do
          if kubectl run health-check-rollback-$i --image=curlimages/curl --rm -i --restart=Never -- \
            curl -f -m 10 http://$SERVICE_IP/actuator/health; then
            echo "âœ… Health check $i passed for $SERVICE"
          else
            echo "âŒ Health check $i failed for $SERVICE"
            if [ $i -eq 5 ]; then
              exit 1
            fi
          fi
          sleep 10
        done
        
        echo "âœ… All health checks passed for $SERVICE"

    - name: ðŸ“Š Record Rollback Event
      run: |
        SERVICE="${{ matrix.service }}"
        
        echo "ðŸ“Š Recording rollback event..."
        
        # Create rollback annotation
        kubectl annotate deployment $SERVICE -n dev \
          rollback.timestamp="$(date -u)" \
          rollback.reason="${{ github.event.inputs.reason }}" \
          rollback.triggered-by="${{ github.actor }}" \
          rollback.run-id="${{ github.run_id }}" \
          rollback.type="${{ github.event.inputs.rollback_type }}" \
          --overwrite
        
        echo "âœ… Rollback event recorded for $SERVICE"

    - name: ðŸ“Š Upload Pre-Rollback State
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pre-rollback-state-${{ matrix.service }}
        path: /tmp/pre-rollback-${{ matrix.service }}.yaml

  # ðŸ” Post-Rollback Verification
  post-rollback-verification:
    name: ðŸ” Post-Rollback Verification
    runs-on: ubuntu-latest
    needs: [pre-rollback-validation, execute-rollback]
    if: always() && needs.pre-rollback-validation.outputs.rollback-approved == 'true'
    steps:
    - name: ðŸ”‘ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ðŸ› ï¸ Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      
    - name: âš™ï¸ Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GCP_ZONE }} \
          --project ${{ env.GCP_PROJECT_ID }}

    - name: ðŸ” Verify System Health
      run: |
        echo "ðŸ” Verifying overall system health after rollback..."
        
        SERVICES_JSON='${{ needs.pre-rollback-validation.outputs.services }}'
        FAILED_SERVICES=0
        
        for SERVICE in $(echo "$SERVICES_JSON" | jq -r '.[]'); do
          echo "Checking $SERVICE..."
          
          # Check deployment status
          if ! kubectl get deployment $SERVICE -n dev >/dev/null 2>&1; then
            echo "âŒ Deployment $SERVICE not found"
            FAILED_SERVICES=$((FAILED_SERVICES + 1))
            continue
          fi
          
          # Check if pods are ready
          READY_PODS=$(kubectl get deployment $SERVICE -n dev -o jsonpath='{.status.readyReplicas}')
          DESIRED_PODS=$(kubectl get deployment $SERVICE -n dev -o jsonpath='{.spec.replicas}')
          
          if [ "$READY_PODS" != "$DESIRED_PODS" ]; then
            echo "âŒ $SERVICE pods not ready ($READY_PODS/$DESIRED_PODS)"
            FAILED_SERVICES=$((FAILED_SERVICES + 1))
          else
            echo "âœ… $SERVICE is healthy ($READY_PODS/$DESIRED_PODS)"
          fi
        done
        
        if [ "$FAILED_SERVICES" -gt 0 ]; then
          echo "âŒ $FAILED_SERVICES service(s) failed health check after rollback"
          exit 1
        else
          echo "âœ… All services are healthy after rollback"
        fi

    - name: ðŸ§ª Run Smoke Tests
      run: |
        echo "ðŸ§ª Running smoke tests on rolled back services..."
        
        # Test API Gateway if it was rolled back
        if echo '${{ needs.pre-rollback-validation.outputs.services }}' | jq -e '.[] | select(. == "api-gateway")' >/dev/null; then
          API_GATEWAY_IP=$(kubectl get svc api-gateway -n dev -o jsonpath='{.spec.clusterIP}')
          
          kubectl run smoke-test --image=curlimages/curl --rm -i --restart=Never -- \
            curl -f -m 10 http://$API_GATEWAY_IP/actuator/health || {
            echo "âŒ API Gateway smoke test failed"
            exit 1
          }
          
          echo "âœ… API Gateway smoke test passed"
        fi
        
        echo "âœ… All smoke tests passed"

  # ðŸ“Š Rollback Summary
  rollback-summary:
    name: ðŸ“Š Emergency Rollback Summary
    runs-on: ubuntu-latest
    needs: [pre-rollback-validation, execute-rollback, post-rollback-verification]
    if: always()
    steps:
    - name: ðŸ“Š Generate Summary
      run: |
        echo "## âš¡ Emergency Rollback Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "**Reason**: ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
        echo "**Service(s)**: ${{ github.event.inputs.service }}" >> $GITHUB_STEP_SUMMARY
        echo "**Rollback Type**: ${{ github.event.inputs.rollback_type }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event.inputs.rollback_type }}" == "specific-version" ]; then
          echo "**Target Version**: ${{ github.event.inputs.specific_version }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Pre-validation**: ${{ needs.pre-rollback-validation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Rollback Execution**: ${{ needs.execute-rollback.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Post-verification**: ${{ needs.post-rollback-verification.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.execute-rollback.result }}" == "success" ] && [ "${{ needs.post-rollback-verification.result }}" == "success" ]; then
          echo "âœ… **Emergency rollback completed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Next Steps**: Monitor system closely and investigate the root cause that triggered this rollback." >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Emergency rollback failed or incomplete**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš¨ **URGENT**: Manual intervention required. Contact DevOps team immediately." >> $GITHUB_STEP_SUMMARY
        fi
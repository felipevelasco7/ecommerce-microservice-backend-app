name: ðŸ”„ Blue-Green Deployment Pipeline

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy with blue-green strategy'
        required: true
        type: choice
        options:
          - api-gateway
          - user-service
          - product-service
          - payment-service
          - order-service
          - shipping-service
          - favourite-service
      image_tag:
        description: 'Image tag to deploy to green environment'
        required: true
        default: 'latest'
      skip_tests:
        description: 'Skip green environment tests'
        required: false
        type: boolean
        default: false

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'axiomatic-fiber-479102-k7' }}
  GCP_ZONE: us-central1-a
  GKE_CLUSTER: ecommerce-cluster
  REGISTRY: gcr.io

jobs:
  # ðŸŸ¢ Deploy to Green Environment
  deploy-green:
    name: ðŸŸ¢ Deploy to Green Environment
    runs-on: ubuntu-latest
    environment: green-deployment
    outputs:
      green-ready: ${{ steps.health-check.outputs.ready }}
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ”‘ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ðŸ› ï¸ Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      
    - name: âš™ï¸ Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GCP_ZONE }} \
          --project ${{ env.GCP_PROJECT_ID }}

    - name: ðŸ” Identify Current Blue Environment
      id: identify-blue
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        
        # Check which environment is currently active (blue)
        ACTIVE_ENV=$(kubectl get svc $SERVICE -n dev -o jsonpath='{.spec.selector.environment}' 2>/dev/null || echo "blue")
        
        if [ "$ACTIVE_ENV" = "blue" ]; then
          echo "GREEN_ENV=green" >> $GITHUB_OUTPUT
          echo "BLUE_ENV=blue" >> $GITHUB_OUTPUT
          echo "ðŸ”µ Current active: BLUE, deploying to: GREEN"
        else
          echo "GREEN_ENV=blue" >> $GITHUB_OUTPUT  
          echo "BLUE_ENV=green" >> $GITHUB_OUTPUT
          echo "ðŸŸ¢ Current active: GREEN, deploying to: BLUE"
        fi

    - name: ðŸŸ¢ Deploy to Green Environment
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        GREEN_ENV="${{ steps.identify-blue.outputs.GREEN_ENV }}"
        
        echo "ðŸŸ¢ Deploying $SERVICE:$IMAGE_TAG to $GREEN_ENV environment..."
        
        # Create green deployment
        cat <<EOF | kubectl apply -f -
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: $SERVICE-$GREEN_ENV
          namespace: dev
          labels:
            app: $SERVICE
            environment: $GREEN_ENV
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: $SERVICE
              environment: $GREEN_ENV
          template:
            metadata:
              labels:
                app: $SERVICE
                environment: $GREEN_ENV
            spec:
              containers:
              - name: $SERVICE
                image: ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$SERVICE:$IMAGE_TAG
                ports:
                - containerPort: 8080
                env:
                - name: ENVIRONMENT
                  value: $GREEN_ENV
                resources:
                  requests:
                    memory: "256Mi"
                    cpu: "200m"
                  limits:
                    memory: "512Mi" 
                    cpu: "500m"
                readinessProbe:
                  httpGet:
                    path: /actuator/health
                    port: 8080
                  initialDelaySeconds: 30
                  periodSeconds: 10
                livenessProbe:
                  httpGet:
                    path: /actuator/health
                    port: 8080
                  initialDelaySeconds: 60
                  periodSeconds: 30
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: $SERVICE-$GREEN_ENV
          namespace: dev
          labels:
            app: $SERVICE
            environment: $GREEN_ENV
        spec:
          selector:
            app: $SERVICE
            environment: $GREEN_ENV
          ports:
          - port: 80
            targetPort: 8080
          type: ClusterIP
        EOF
        
        echo "â³ Waiting for green deployment to be ready..."
        kubectl rollout status deployment/$SERVICE-$GREEN_ENV -n dev --timeout=300s
        
        echo "âœ… Green deployment ready"

    - name: ðŸ©º Health Check Green Environment  
      id: health-check
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        GREEN_ENV="${{ steps.identify-blue.outputs.GREEN_ENV }}"
        
        echo "ðŸ©º Running health checks on green environment..."
        
        # Wait for service to be fully ready
        sleep 30
        
        # Get service IP
        GREEN_IP=$(kubectl get svc $SERVICE-$GREEN_ENV -n dev -o jsonpath='{.spec.clusterIP}')
        
        # Run health check
        for i in {1..5}; do
          if kubectl run health-check-$i --image=curlimages/curl --rm -i --restart=Never -- \
            curl -f -m 10 http://$GREEN_IP/actuator/health; then
            echo "âœ… Health check $i passed"
          else
            echo "âŒ Health check $i failed"
            echo "ready=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          sleep 10
        done
        
        echo "ready=true" >> $GITHUB_OUTPUT
        echo "âœ… All health checks passed"

  # ðŸ§ª Test Green Environment
  test-green:
    name: ðŸ§ª Test Green Environment
    runs-on: ubuntu-latest
    needs: deploy-green
    if: ${{ !inputs.skip_tests && needs.deploy-green.outputs.green-ready == 'true' }}
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ”‘ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ðŸ› ï¸ Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      
    - name: âš™ï¸ Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GCP_ZONE }} \
          --project ${{ env.GCP_PROJECT_ID }}

    - name: ðŸ§ª Run Integration Tests
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        
        echo "ðŸ§ª Running integration tests on green environment..."
        
        # Get green service endpoint
        GREEN_ENV=$(kubectl get svc $SERVICE-green -n dev >/dev/null 2>&1 && echo "green" || echo "blue")
        GREEN_IP=$(kubectl get svc $SERVICE-$GREEN_ENV -n dev -o jsonpath='{.spec.clusterIP}')
        
        # Run comprehensive tests
        kubectl run integration-test --image=curlimages/curl --rm -i --restart=Never -- sh -c "
          echo 'Testing basic endpoints...'
          curl -f http://$GREEN_IP/actuator/health || exit 1
          curl -f http://$GREEN_IP/actuator/info || exit 1
          echo 'All integration tests passed!'
        "
        
        echo "âœ… Integration tests completed successfully"

  # ðŸ”„ Switch Traffic (Blue -> Green)
  switch-traffic:
    name: ðŸ”„ Switch Traffic to Green
    runs-on: ubuntu-latest
    needs: [deploy-green, test-green]
    if: always() && (needs.deploy-green.outputs.green-ready == 'true' && (needs.test-green.result == 'success' || inputs.skip_tests))
    environment: production-switch
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ”‘ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ðŸ› ï¸ Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      
    - name: âš™ï¸ Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GCP_ZONE }} \
          --project ${{ env.GCP_PROJECT_ID }}

    - name: ðŸ”„ Switch Traffic to Green
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        
        # Determine which is green
        GREEN_ENV=$(kubectl get svc $SERVICE-green -n dev >/dev/null 2>&1 && echo "green" || echo "blue")
        BLUE_ENV=$([ "$GREEN_ENV" = "green" ] && echo "blue" || echo "green")
        
        echo "ðŸ”„ Switching traffic from $BLUE_ENV to $GREEN_ENV..."
        
        # Update main service to point to green environment
        kubectl patch svc $SERVICE -n dev -p "{\"spec\":{\"selector\":{\"app\":\"$SERVICE\",\"environment\":\"$GREEN_ENV\"}}}"
        
        echo "âœ… Traffic switched to green environment"
        echo "â³ Monitoring for 2 minutes..."
        
        # Monitor for issues
        sleep 120
        
        echo "âœ… Traffic switch completed successfully"

  # ðŸ§¹ Cleanup Old Blue Environment  
  cleanup-blue:
    name: ðŸ§¹ Cleanup Old Blue Environment
    runs-on: ubuntu-latest
    needs: [deploy-green, switch-traffic]
    if: always() && needs.switch-traffic.result == 'success'
    steps:
    - name: ðŸ”‘ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ðŸ› ï¸ Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      
    - name: âš™ï¸ Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GCP_ZONE }} \
          --project ${{ env.GCP_PROJECT_ID }}

    - name: ðŸ§¹ Cleanup Old Blue Environment
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        
        # Determine which was the old blue environment
        GREEN_ENV=$(kubectl get svc $SERVICE -n dev -o jsonpath='{.spec.selector.environment}')
        BLUE_ENV=$([ "$GREEN_ENV" = "green" ] && echo "blue" || echo "green")
        
        echo "ðŸ§¹ Cleaning up old blue environment ($BLUE_ENV)..."
        
        # Keep old deployment for quick rollback (scale to 0)
        kubectl scale deployment $SERVICE-$BLUE_ENV -n dev --replicas=0 || true
        
        echo "âœ… Old blue environment scaled down (kept for rollback)"

  # âš ï¸ Rollback Job (Manual Trigger)
  rollback:
    name: âš ï¸ Emergency Rollback
    runs-on: ubuntu-latest
    if: failure()
    steps:
    - name: ðŸ”‘ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ðŸ› ï¸ Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      
    - name: âš™ï¸ Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GCP_ZONE }} \
          --project ${{ env.GCP_PROJECT_ID }}

    - name: âš ï¸ Rollback to Blue Environment
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        
        echo "âš ï¸ Emergency rollback initiated..."
        
        # Find the original blue environment
        CURRENT_ENV=$(kubectl get svc $SERVICE -n dev -o jsonpath='{.spec.selector.environment}' || echo "green")
        BLUE_ENV=$([ "$CURRENT_ENV" = "green" ] && echo "blue" || echo "green")
        
        # Scale up blue environment
        kubectl scale deployment $SERVICE-$BLUE_ENV -n dev --replicas=2
        kubectl rollout status deployment/$SERVICE-$BLUE_ENV -n dev --timeout=300s
        
        # Switch traffic back to blue
        kubectl patch svc $SERVICE -n dev -p "{\"spec\":{\"selector\":{\"app\":\"$SERVICE\",\"environment\":\"$BLUE_ENV\"}}}"
        
        echo "âœ… Rollback completed - traffic restored to blue environment"

  # ðŸ“Š Deployment Summary
  summary:
    name: ðŸ“Š Blue-Green Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-green, test-green, switch-traffic, cleanup-blue, rollback]
    if: always()
    steps:
    - name: ðŸ“Š Generate Summary
      run: |
        echo "## ðŸ”„ Blue-Green Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Service**: ${{ github.event.inputs.service }}" >> $GITHUB_STEP_SUMMARY
        echo "**Image Tag**: ${{ github.event.inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
        echo "**Skip Tests**: ${{ github.event.inputs.skip_tests }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Job Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Green Deployment**: ${{ needs.deploy-green.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Green Testing**: ${{ needs.test-green.result }}" >> $GITHUB_STEP_SUMMARY  
        echo "- **Traffic Switch**: ${{ needs.switch-traffic.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Blue Cleanup**: ${{ needs.cleanup-blue.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Rollback**: ${{ needs.rollback.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.switch-traffic.result }}" == "success" ]; then
          echo "ðŸŽ‰ **Blue-Green deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.rollback.result }}" == "success" ]; then
          echo "âš ï¸ **Deployment failed but rollback was successful**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Blue-Green deployment failed**" >> $GITHUB_STEP_SUMMARY
        fi
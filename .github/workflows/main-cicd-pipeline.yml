name: ðŸš€ Main CI/CD Pipeline - Ecommerce Microservices

on:
  push:
    branches: [ master, main ]
    paths:
      - 'microservices/**'
      - 'k8s/**'
      - 'pom.xml'
      - '.github/workflows/**'
  pull_request:
    branches: [ master, main ]

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'axiomatic-fiber-479102-k7' }}
  GCP_ZONE: us-central1-a
  GKE_CLUSTER: ecommerce-cluster
  REGISTRY: gcr.io

jobs:
  # ðŸ” Detectar cambios en microservicios
  detect-changes:
    name: ðŸ” Detect Service Changes
    runs-on: ubuntu-latest
    outputs:
      api-gateway: ${{ steps.changes.outputs.api-gateway }}
      user-service: ${{ steps.changes.outputs.user-service }}
      product-service: ${{ steps.changes.outputs.product-service }}
      payment-service: ${{ steps.changes.outputs.payment-service }}
      order-service: ${{ steps.changes.outputs.order-service }}
      shipping-service: ${{ steps.changes.outputs.shipping-service }}
      favourite-service: ${{ steps.changes.outputs.favourite-service }}
      cloud-config: ${{ steps.changes.outputs.cloud-config }}
      service-discovery: ${{ steps.changes.outputs.service-discovery }}
      proxy-client: ${{ steps.changes.outputs.proxy-client }}
      frontend: ${{ steps.changes.outputs.frontend }}
      k8s-configs: ${{ steps.changes.outputs.k8s-configs }}
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ” Detect Changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          api-gateway:
            - 'microservices/api-gateway/**'
          user-service:
            - 'microservices/user-service/**'
          product-service:
            - 'microservices/product-service/**'
          payment-service:
            - 'microservices/payment-service/**'
          order-service:
            - 'microservices/order-service/**'
          shipping-service:
            - 'microservices/shipping-service/**'
          favourite-service:
            - 'microservices/favourite-service/**'
          cloud-config:
            - 'microservices/cloud-config/**'
          service-discovery:
            - 'microservices/service-discovery/**'
          proxy-client:
            - 'microservices/proxy-client/**'
          frontend:
            - 'microservices/frontend/**'
          k8s-configs:
            - 'k8s/**'
            - 'helm/**'

  # ðŸ§ª Testing y Security Scanning
  test-and-security:
    name: ðŸ§ª Test & Security Scan
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.api-gateway == 'true' ||
      needs.detect-changes.outputs.user-service == 'true' ||
      needs.detect-changes.outputs.product-service == 'true' ||
      needs.detect-changes.outputs.payment-service == 'true' ||
      needs.detect-changes.outputs.order-service == 'true' ||
      needs.detect-changes.outputs.shipping-service == 'true' ||
      needs.detect-changes.outputs.favourite-service == 'true' ||
      needs.detect-changes.outputs.cloud-config == 'true' ||
      needs.detect-changes.outputs.service-discovery == 'true' ||
      needs.detect-changes.outputs.proxy-client == 'true'
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: ðŸ“¦ Cache Maven Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: ðŸ§ª Run Unit Tests
      run: |
        echo "ðŸ§ª Running unit tests for changed services..."
        mvn clean test -B
        
    - name: ðŸ“Š Generate Test Reports
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: ðŸ“Š Maven Tests
        path: '**/target/surefire-reports/*.xml'
        reporter: java-junit
        
    - name: ðŸ” Security Scan - Dependencies
      run: |
        echo "ðŸ” Scanning for vulnerabilities..."
        mvn org.owasp:dependency-check-maven:check || true
        
    - name: ðŸ” Code Quality Analysis
      run: |
        echo "ðŸ” Analyzing code quality..."
        mvn compile || true

  # ðŸ—ï¸ Build and Push Images
  build-and-push:
    name: ðŸ—ï¸ Build & Push Images
    runs-on: ubuntu-latest
    needs: [detect-changes, test-and-security]
    if: github.event_name == 'push'
    strategy:
      matrix:
        service: [
          api-gateway, user-service, product-service, payment-service,
          order-service, shipping-service, favourite-service,
          cloud-config, service-discovery, proxy-client, frontend
        ]
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
      if: matrix.service != 'frontend'
        
    - name: ðŸ”‘ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
      if: needs.detect-changes.outputs[matrix.service] == 'true'
        
    - name: ðŸ› ï¸ Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      if: needs.detect-changes.outputs[matrix.service] == 'true'
        
    - name: ðŸ³ Configure Docker for GCR
      run: gcloud auth configure-docker
      if: needs.detect-changes.outputs[matrix.service] == 'true'
      
    - name: ðŸ“¦ Build Maven Project
      run: |
        if [ -f "microservices/${{ matrix.service }}/pom.xml" ]; then
          echo "ðŸ—ï¸ Building ${{ matrix.service }}..."
          mvn clean package -DskipTests -f microservices/${{ matrix.service }}/pom.xml
        fi
      if: needs.detect-changes.outputs[matrix.service] == 'true' && matrix.service != 'frontend'
      
    - name: ðŸ³ Build and Push Docker Image
      run: |
        if [ -f "microservices/${{ matrix.service }}/Dockerfile" ]; then
          echo "ðŸ³ Building Docker image for ${{ matrix.service }}..."
          
          # Build image
          docker build \
            -f microservices/${{ matrix.service }}/Dockerfile \
            -t ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ matrix.service }}:${{ github.sha }} \
            -t ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ matrix.service }}:latest \
            .
          
          # Push images
          docker push ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ matrix.service }}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ matrix.service }}:latest
          
          echo "âœ… Successfully built and pushed ${{ matrix.service }}"
        else
          echo "âš ï¸ No Dockerfile found for ${{ matrix.service }}"
        fi
      if: needs.detect-changes.outputs[matrix.service] == 'true'

  # ðŸš€ Deploy to Development
  deploy-to-dev:
    name: ðŸš€ Deploy to Development
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-push]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    environment: development
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ”‘ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ðŸ› ï¸ Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      
    - name: âš™ï¸ Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GCP_ZONE }} \
          --project ${{ env.GCP_PROJECT_ID }}
          
    - name: ðŸš€ Deploy Changed Services
      run: |
        echo "ðŸš€ Deploying changed services to development..."
        
        # Update image tags in deployments
        for service in api-gateway user-service product-service payment-service order-service shipping-service favourite-service cloud-config service-discovery proxy-client frontend; do
          if [ "${{ needs.detect-changes.outputs[service] }}" == "true" ]; then
            echo "ðŸ“¦ Updating $service deployment..."
            
            if kubectl get deployment $service -n dev >/dev/null 2>&1; then
              kubectl set image deployment/$service $service=${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$service:${{ github.sha }} -n dev
              kubectl rollout status deployment/$service -n dev --timeout=300s
            else
              echo "âš ï¸ Deployment $service not found in dev namespace"
            fi
          fi
        done
        
    - name: âœ… Verify Deployment
      run: |
        echo "âœ… Verifying deployment health..."
        kubectl get pods -n dev
        kubectl get svc -n dev
        
        # Check if services are healthy
        for service in api-gateway user-service product-service; do
          if kubectl get deployment $service -n dev >/dev/null 2>&1; then
            kubectl wait --for=condition=available --timeout=300s deployment/$service -n dev || true
          fi
        done

  # ðŸ“Š Notify Results
  notify:
    name: ðŸ“Š Notify Pipeline Results
    runs-on: ubuntu-latest
    needs: [detect-changes, test-and-security, build-and-push, deploy-to-dev]
    if: always()
    steps:
    - name: ðŸ“Š Pipeline Summary
      run: |
        echo "## ðŸ“Š Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ” Changes Detected**: ${{ needs.detect-changes.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ§ª Tests & Security**: ${{ needs.test-and-security.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ—ï¸ Build & Push**: ${{ needs.build-and-push.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸš€ Deployment**: ${{ needs.deploy-to-dev.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Services Changed:" >> $GITHUB_STEP_SUMMARY
        
        services=("api-gateway" "user-service" "product-service" "payment-service" "order-service" "shipping-service" "favourite-service" "cloud-config" "service-discovery" "proxy-client" "frontend")
        
        for service in "${services[@]}"; do
          if [ "${{ needs.detect-changes.outputs[service] }}" == "true" ]; then
            echo "- âœ… $service" >> $GITHUB_STEP_SUMMARY
          fi
        done
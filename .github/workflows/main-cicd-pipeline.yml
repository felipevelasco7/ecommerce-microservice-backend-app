name: ðŸ“¦ Main CI/CD Pipeline

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '*.md'  
      - 'docs/**'
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'axiomatic-fiber-479102-k7' }}
  GCP_ZONE: us-central1-a
  GKE_CLUSTER: ecommerce-cluster
  REGISTRY: gcr.io

jobs:
  # ðŸ” Detect Changes
  detect-changes:
    name: ðŸ” Detect Service Changes
    runs-on: ubuntu-latest
    outputs:
      any-changes: ${{ steps.changes.outputs.any-changes }}
      api-gateway: ${{ steps.changes.outputs.api-gateway }}
      user-service: ${{ steps.changes.outputs.user-service }}
      product-service: ${{ steps.changes.outputs.product-service }}
      payment-service: ${{ steps.changes.outputs.payment-service }}
      order-service: ${{ steps.changes.outputs.order-service }}
      shipping-service: ${{ steps.changes.outputs.shipping-service }}
      favourite-service: ${{ steps.changes.outputs.favourite-service }}
      cloud-config: ${{ steps.changes.outputs.cloud-config }}
      service-discovery: ${{ steps.changes.outputs.service-discovery }}
      proxy-client: ${{ steps.changes.outputs.proxy-client }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ” Detect Changes
      id: changes
      run: |
        echo "Detecting changes in microservices..."
        
        # If this is the first push or no previous commit, build all
        if ! git rev-parse HEAD~1 >/dev/null 2>&1; then
          echo "First commit detected, building all services"
          echo "any-changes=true" >> $GITHUB_OUTPUT
          echo "api-gateway=true" >> $GITHUB_OUTPUT
          echo "user-service=true" >> $GITHUB_OUTPUT
          echo "product-service=true" >> $GITHUB_OUTPUT
          echo "payment-service=true" >> $GITHUB_OUTPUT
          echo "order-service=true" >> $GITHUB_OUTPUT
          echo "shipping-service=true" >> $GITHUB_OUTPUT
          echo "favourite-service=true" >> $GITHUB_OUTPUT
          echo "cloud-config=true" >> $GITHUB_OUTPUT
          echo "service-discovery=true" >> $GITHUB_OUTPUT
          echo "proxy-client=true" >> $GITHUB_OUTPUT
          echo "frontend=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Check for changes in each service
        services=("api-gateway" "user-service" "product-service" "payment-service" "order-service" "shipping-service" "favourite-service" "cloud-config" "service-discovery" "proxy-client" "frontend")
        any_changes=false
        
        for service in "${services[@]}"; do
          if git diff --name-only HEAD~1 HEAD | grep -E "^microservices/$service/|^k8s/.*$service" >/dev/null; then
            echo "$service=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in $service"
            any_changes=true
          else
            echo "$service=false" >> $GITHUB_OUTPUT
            echo "âž– No changes in $service"
          fi
        done
        
        # Set overall flag
        echo "any-changes=$any_changes" >> $GITHUB_OUTPUT
        
        if [ "$any_changes" = "true" ]; then
          echo "ðŸš€ Pipeline will proceed with changed services"
        else
          echo "â¸ï¸ No service changes detected, skipping build"
        fi

  # ðŸ§ª Test and Security Analysis
  test-and-security:
    name: ðŸ§ª Test & Security Analysis
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any-changes == 'true'
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: ðŸ§ª Run Unit Tests
      run: |
        echo "ðŸ§ª Running unit tests for changed services..."
        
        # Test services that have changed
        test_service() {
          local service=$1
          local changed=$2
          
          if [ "$changed" == "true" ] && [ -f "microservices/$service/pom.xml" ]; then
            echo "Testing $service..."
            mvn test -f microservices/$service/pom.xml || exit 1
          fi
        }
        
        # Test each service if changed
        test_service "api-gateway" "${{ needs.detect-changes.outputs.api-gateway }}"
        test_service "user-service" "${{ needs.detect-changes.outputs.user-service }}"
        test_service "product-service" "${{ needs.detect-changes.outputs.product-service }}"
        test_service "payment-service" "${{ needs.detect-changes.outputs.payment-service }}"
        test_service "order-service" "${{ needs.detect-changes.outputs.order-service }}"
        test_service "shipping-service" "${{ needs.detect-changes.outputs.shipping-service }}"
        test_service "favourite-service" "${{ needs.detect-changes.outputs.favourite-service }}"
        test_service "cloud-config" "${{ needs.detect-changes.outputs.cloud-config }}"
        test_service "service-discovery" "${{ needs.detect-changes.outputs.service-discovery }}"
        test_service "proxy-client" "${{ needs.detect-changes.outputs.proxy-client }}"
        
        echo "âœ… All tests completed successfully"

    - name: ðŸ”’ Security Scan
      run: |
        echo "ðŸ”’ Running security scans..."
        
        # Maven security scan for Java services
        for service_dir in microservices/*/; do
          if [ -f "$service_dir/pom.xml" ]; then
            service_name=$(basename "$service_dir")
            echo "Scanning $service_name for vulnerabilities..."
            mvn org.owasp:dependency-check-maven:check -f "$service_dir/pom.xml" || echo "âš ï¸ Security scan warning for $service_name"
          fi
        done
        
        echo "âœ… Security scan completed"

  # ðŸ—ï¸ Build and Push Images
  build-and-push:
    name: ðŸ—ï¸ Build & Push Images
    runs-on: ubuntu-latest
    needs: [detect-changes, test-and-security]
    if: needs.detect-changes.outputs.any-changes == 'true'
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: ðŸ”‘ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ðŸ› ï¸ Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
        
    - name: ðŸ³ Configure Docker for GCR
      run: gcloud auth configure-docker
      
    - name: ðŸ—ï¸ Build and Push Services
      run: |
        echo "ðŸ—ï¸ Building and pushing changed services..."
        
        build_and_push_service() {
          local service=$1
          local changed=$2
          
          if [ "$changed" == "true" ]; then
            echo "ðŸ”¨ Building $service..."
            
            # Build Maven project if exists
            if [ -f "microservices/$service/pom.xml" ]; then
              echo "ðŸ“¦ Building Maven project for $service..."
              mvn clean package -DskipTests -f microservices/$service/pom.xml
            fi
            
            # Build and push Docker image if Dockerfile exists
            if [ -f "microservices/$service/Dockerfile" ]; then
              echo "ðŸ³ Building Docker image for $service..."
              
              # Build image
              docker build \
                -f microservices/$service/Dockerfile \
                -t ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$service:${{ github.sha }} \
                -t ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$service:latest \
                microservices/$service/
              
              # Push images
              docker push ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$service:${{ github.sha }}
              docker push ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$service:latest
              
              echo "âœ… Successfully built and pushed $service"
            else
              echo "âš ï¸ No Dockerfile found for $service"
            fi
          else
            echo "â­ï¸ Skipping $service (no changes)"
          fi
        }
        
        # Build each service if changed
        build_and_push_service "api-gateway" "${{ needs.detect-changes.outputs.api-gateway }}"
        build_and_push_service "user-service" "${{ needs.detect-changes.outputs.user-service }}"
        build_and_push_service "product-service" "${{ needs.detect-changes.outputs.product-service }}"
        build_and_push_service "payment-service" "${{ needs.detect-changes.outputs.payment-service }}"
        build_and_push_service "order-service" "${{ needs.detect-changes.outputs.order-service }}"
        build_and_push_service "shipping-service" "${{ needs.detect-changes.outputs.shipping-service }}"
        build_and_push_service "favourite-service" "${{ needs.detect-changes.outputs.favourite-service }}"
        build_and_push_service "cloud-config" "${{ needs.detect-changes.outputs.cloud-config }}"
        build_and_push_service "service-discovery" "${{ needs.detect-changes.outputs.service-discovery }}"
        build_and_push_service "proxy-client" "${{ needs.detect-changes.outputs.proxy-client }}"
        build_and_push_service "frontend" "${{ needs.detect-changes.outputs.frontend }}"

  # ðŸš€ Deploy to Development
  deploy-to-dev:
    name: ðŸš€ Deploy to Development
    runs-on: ubuntu-latest
    environment: development
    needs: [detect-changes, build-and-push]
    if: needs.detect-changes.outputs.any-changes == 'true'
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”‘ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ðŸ› ï¸ Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      
    - name: âš™ï¸ Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GCP_ZONE }} \
          --project ${{ env.GCP_PROJECT_ID }}
          
    - name: ðŸš€ Deploy Changed Services
      run: |
        echo "ðŸš€ Deploying changed services to development..."
        
        # Function to deploy service
        deploy_service() {
          local service=$1
          local changed=$2
          
          if [ "$changed" == "true" ]; then
            echo "ðŸ“¦ Deploying $service..."
            
            # Check if deployment exists, if not apply from k8s manifests
            if kubectl get deployment $service -n dev >/dev/null 2>&1; then
              # Update existing deployment
              kubectl set image deployment/$service $service=${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$service:${{ github.sha }} -n dev
              kubectl rollout status deployment/$service -n dev --timeout=300s
            else
              # Apply from k8s manifests
              echo "Creating new deployment for $service..."
              kubectl apply -f k8s/deployments/$service.yaml -n dev || echo "âš ï¸ No k8s manifest for $service"
              kubectl apply -f k8s/services/$service.yaml -n dev || echo "âš ï¸ No service manifest for $service"
            fi
            
            echo "âœ… $service deployed successfully"
          else
            echo "â­ï¸ Skipping $service deployment (no changes)"
          fi
        }
        
        # Deploy changed services
        deploy_service "api-gateway" "${{ needs.detect-changes.outputs.api-gateway }}"
        deploy_service "user-service" "${{ needs.detect-changes.outputs.user-service }}"
        deploy_service "product-service" "${{ needs.detect-changes.outputs.product-service }}"
        deploy_service "payment-service" "${{ needs.detect-changes.outputs.payment-service }}"
        deploy_service "order-service" "${{ needs.detect-changes.outputs.order-service }}"
        deploy_service "shipping-service" "${{ needs.detect-changes.outputs.shipping-service }}"
        deploy_service "favourite-service" "${{ needs.detect-changes.outputs.favourite-service }}"
        deploy_service "cloud-config" "${{ needs.detect-changes.outputs.cloud-config }}"
        deploy_service "service-discovery" "${{ needs.detect-changes.outputs.service-discovery }}"
        deploy_service "proxy-client" "${{ needs.detect-changes.outputs.proxy-client }}"
        deploy_service "frontend" "${{ needs.detect-changes.outputs.frontend }}"
        
        echo "ðŸŽ‰ Deployment completed!"

    - name: ðŸ©º Health Check
      run: |
        echo "ðŸ©º Running health checks..."
        
        # Wait for services to be ready
        sleep 30
        
        # Check service health
        check_service_health() {
          local service=$1
          local changed=$2
          
          if [ "$changed" == "true" ]; then
            if kubectl get pods -l app=$service -n dev | grep -q "Running"; then
              echo "âœ… $service is healthy"
            else
              echo "âš ï¸ $service may have issues"
              kubectl get pods -l app=$service -n dev || echo "No pods found for $service"
            fi
          fi
        }
        
        check_service_health "api-gateway" "${{ needs.detect-changes.outputs.api-gateway }}"
        check_service_health "user-service" "${{ needs.detect-changes.outputs.user-service }}"
        check_service_health "product-service" "${{ needs.detect-changes.outputs.product-service }}"
        check_service_health "payment-service" "${{ needs.detect-changes.outputs.payment-service }}"
        check_service_health "order-service" "${{ needs.detect-changes.outputs.order-service }}"
        check_service_health "shipping-service" "${{ needs.detect-changes.outputs.shipping-service }}"
        check_service_health "favourite-service" "${{ needs.detect-changes.outputs.favourite-service }}"
        
        echo "ðŸ¥ Health check completed"

  # ðŸ“Š Pipeline Summary
  pipeline-summary:
    name: ðŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, test-and-security, build-and-push, deploy-to-dev]
    if: always()
    steps:
    - name: ðŸ“Š Generate Summary
      run: |
        echo "## ðŸ“Š Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Job Results" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ” Changes Detected**: ${{ needs.detect-changes.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ§ª Tests & Security**: ${{ needs.test-and-security.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ—ï¸ Build & Push**: ${{ needs.build-and-push.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸš€ Deployment**: ${{ needs.deploy-to-dev.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Services Changed:" >> $GITHUB_STEP_SUMMARY
        
        # Display changed services
        [ "${{ needs.detect-changes.outputs.api-gateway }}" == "true" ] && echo "- âœ… api-gateway" >> $GITHUB_STEP_SUMMARY
        [ "${{ needs.detect-changes.outputs.user-service }}" == "true" ] && echo "- âœ… user-service" >> $GITHUB_STEP_SUMMARY
        [ "${{ needs.detect-changes.outputs.product-service }}" == "true" ] && echo "- âœ… product-service" >> $GITHUB_STEP_SUMMARY
        [ "${{ needs.detect-changes.outputs.payment-service }}" == "true" ] && echo "- âœ… payment-service" >> $GITHUB_STEP_SUMMARY
        [ "${{ needs.detect-changes.outputs.order-service }}" == "true" ] && echo "- âœ… order-service" >> $GITHUB_STEP_SUMMARY
        [ "${{ needs.detect-changes.outputs.shipping-service }}" == "true" ] && echo "- âœ… shipping-service" >> $GITHUB_STEP_SUMMARY
        [ "${{ needs.detect-changes.outputs.favourite-service }}" == "true" ] && echo "- âœ… favourite-service" >> $GITHUB_STEP_SUMMARY
        [ "${{ needs.detect-changes.outputs.cloud-config }}" == "true" ] && echo "- âœ… cloud-config" >> $GITHUB_STEP_SUMMARY
        [ "${{ needs.detect-changes.outputs.service-discovery }}" == "true" ] && echo "- âœ… service-discovery" >> $GITHUB_STEP_SUMMARY
        [ "${{ needs.detect-changes.outputs.proxy-client }}" == "true" ] && echo "- âœ… proxy-client" >> $GITHUB_STEP_SUMMARY
        [ "${{ needs.detect-changes.outputs.frontend }}" == "true" ] && echo "- âœ… frontend" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.deploy-to-dev.result }}" == "success" ]; then
          echo "ðŸŽ‰ **Pipeline completed successfully!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Pipeline failed. Check logs for details.**" >> $GITHUB_STEP_SUMMARY
        fi
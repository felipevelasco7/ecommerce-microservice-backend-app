name: ðŸ›¡ï¸ Security & Compliance Pipeline

on:
  schedule:
    # Run daily security scans at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan to run'
        required: true
        type: choice
        options:
          - all
          - vulnerability
          - secrets
          - compliance
          - license
      severity_threshold:
        description: 'Minimum severity level to report'
        required: false
        type: choice
        default: 'medium'
        options:
          - low
          - medium
          - high
          - critical

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'axiomatic-fiber-479102-k7' }}
  GCP_ZONE: us-central1-a
  GKE_CLUSTER: ecommerce-cluster
  REGISTRY: gcr.io

jobs:
  # ðŸ” Vulnerability Scanning
  vulnerability-scan:
    name: ðŸ” Vulnerability Scanning
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'vulnerability' || github.event_name == 'schedule' }}
    strategy:
      matrix:
        service: [api-gateway, user-service, product-service, payment-service, order-service, shipping-service, favourite-service]
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”‘ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ðŸ› ï¸ Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2

    - name: ðŸ” Scan Container Images
      run: |
        SERVICE="${{ matrix.service }}"
        SEVERITY="${{ github.event.inputs.severity_threshold || 'medium' }}"
        
        echo "ðŸ” Scanning $SERVICE container for vulnerabilities..."
        
        # Get latest image tag
        IMAGE_TAG=$(gcloud container images list-tags ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$SERVICE \
          --limit=1 --format="get(tags[0])" 2>/dev/null || echo "latest")
        
        if [ -z "$IMAGE_TAG" ]; then
          echo "âš ï¸ No image found for $SERVICE, skipping..."
          exit 0
        fi
        
        IMAGE_URL="${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$SERVICE:$IMAGE_TAG"
        
        # Run vulnerability scan using gcloud
        gcloud container images scan $IMAGE_URL \
          --quiet \
          --format="table(vulnerability.severity,vulnerability.cvssScore,vulnerability.packageIssue[0].affectedPackage.name,vulnerability.packageIssue[0].affectedVersion.name,vulnerability.shortDescription)" \
          > /tmp/vuln-scan-$SERVICE.txt || true
        
        # Filter by severity
        case "$SEVERITY" in
          "critical") PATTERN="CRITICAL" ;;
          "high") PATTERN="CRITICAL\|HIGH" ;;
          "medium") PATTERN="CRITICAL\|HIGH\|MEDIUM" ;;
          "low") PATTERN="CRITICAL\|HIGH\|MEDIUM\|LOW" ;;
        esac
        
        # Check for vulnerabilities
        if grep -E "$PATTERN" /tmp/vuln-scan-$SERVICE.txt; then
          echo "âš ï¸ Vulnerabilities found in $SERVICE:"
          cat /tmp/vuln-scan-$SERVICE.txt
          
          # Count critical and high vulnerabilities
          CRITICAL_COUNT=$(grep -c "CRITICAL" /tmp/vuln-scan-$SERVICE.txt || echo 0)
          HIGH_COUNT=$(grep -c "HIGH" /tmp/vuln-scan-$SERVICE.txt || echo 0)
          
          if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 5 ]; then
            echo "âŒ Security threshold exceeded for $SERVICE"
            echo "Critical: $CRITICAL_COUNT, High: $HIGH_COUNT"
            exit 1
          fi
        else
          echo "âœ… No $SEVERITY+ vulnerabilities found in $SERVICE"
        fi

    - name: ðŸ“Š Upload Vulnerability Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: vuln-report-${{ matrix.service }}
        path: /tmp/vuln-scan-${{ matrix.service }}.txt

  # ðŸ” Secret Scanning  
  secret-scan:
    name: ðŸ” Secret Scanning
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'secrets' || github.event_name == 'schedule' }}
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ” Install TruffleHog
      run: |
        curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

    - name: ðŸ” Scan for Secrets
      run: |
        echo "ðŸ” Scanning repository for leaked secrets..."
        
        # Run TruffleHog scan
        trufflehog git file://. \
          --json \
          --no-verification \
          --exclude-paths=.trufflehogignore \
          > /tmp/secrets-scan.json || true
        
        # Check if secrets were found
        if [ -s /tmp/secrets-scan.json ]; then
          echo "âš ï¸ Potential secrets found:"
          jq -r '.DetectorName + ": " + .Raw[:50] + "..." + " in " + .SourceMetadata.Data.Filesystem.file' /tmp/secrets-scan.json
          
          # Count findings
          SECRET_COUNT=$(jq -s length /tmp/secrets-scan.json)
          echo "Total potential secrets: $SECRET_COUNT"
          
          if [ "$SECRET_COUNT" -gt 0 ]; then
            echo "âŒ Secrets detected in repository"
            exit 1
          fi
        else
          echo "âœ… No secrets detected in repository"
        fi

    - name: ðŸ“Š Upload Secret Scan Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: secret-scan-report
        path: /tmp/secrets-scan.json

  # ðŸ“‹ Compliance Check
  compliance-check:
    name: ðŸ“‹ Compliance Check
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'compliance' || github.event_name == 'schedule' }}
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”‘ Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ðŸ› ï¸ Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      
    - name: âš™ï¸ Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GCP_ZONE }} \
          --project ${{ env.GCP_PROJECT_ID }}

    - name: ðŸ“‹ Check Kubernetes Security Policies
      run: |
        echo "ðŸ“‹ Checking Kubernetes security compliance..."
        
        # Check for security policies
        POLICY_VIOLATIONS=0
        
        echo "ðŸ” Checking for pods without resource limits..."
        PODS_WITHOUT_LIMITS=$(kubectl get pods -A -o jsonpath='{range .items[*]}{.metadata.name}{" "}{.spec.containers[*].resources.limits}{"\n"}{end}' | grep -c "^[^ ]* $" || echo 0)
        if [ "$PODS_WITHOUT_LIMITS" -gt 0 ]; then
          echo "âš ï¸ Found $PODS_WITHOUT_LIMITS pods without resource limits"
          POLICY_VIOLATIONS=$((POLICY_VIOLATIONS + 1))
        fi
        
        echo "ðŸ” Checking for pods running as root..."
        ROOT_PODS=$(kubectl get pods -A -o jsonpath='{range .items[*]}{.metadata.name}{" "}{.spec.securityContext.runAsUser}{"\n"}{end}' | grep -c " 0$" || echo 0)
        if [ "$ROOT_PODS" -gt 0 ]; then
          echo "âš ï¸ Found $ROOT_PODS pods running as root"
          POLICY_VIOLATIONS=$((POLICY_VIOLATIONS + 1))
        fi
        
        echo "ðŸ” Checking for missing network policies..."
        NAMESPACES_WITHOUT_NETPOL=$(kubectl get namespaces -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' | while read ns; do
          if [ "$ns" != "kube-system" ] && [ "$ns" != "kube-public" ] && [ "$ns" != "kube-node-lease" ]; then
            if ! kubectl get networkpolicies -n "$ns" >/dev/null 2>&1; then
              echo "$ns"
            fi
          fi
        done | wc -l)
        
        if [ "$NAMESPACES_WITHOUT_NETPOL" -gt 0 ]; then
          echo "âš ï¸ Found $NAMESPACES_WITHOUT_NETPOL namespaces without network policies"
          POLICY_VIOLATIONS=$((POLICY_VIOLATIONS + 1))
        fi
        
        echo "Total policy violations: $POLICY_VIOLATIONS"
        
        if [ "$POLICY_VIOLATIONS" -gt 3 ]; then
          echo "âŒ Too many compliance violations detected"
          exit 1
        else
          echo "âœ… Compliance check passed with $POLICY_VIOLATIONS minor violations"
        fi

    - name: ðŸ“Š Generate Compliance Report
      run: |
        echo "# ðŸ“‹ Kubernetes Security Compliance Report" > /tmp/compliance-report.md
        echo "" >> /tmp/compliance-report.md
        echo "**Date**: $(date)" >> /tmp/compliance-report.md
        echo "**Cluster**: ${{ env.GKE_CLUSTER }}" >> /tmp/compliance-report.md
        echo "" >> /tmp/compliance-report.md
        echo "## Summary" >> /tmp/compliance-report.md
        echo "- Resource Limits: Checked" >> /tmp/compliance-report.md
        echo "- Root User Policy: Checked" >> /tmp/compliance-report.md
        echo "- Network Policies: Checked" >> /tmp/compliance-report.md

    - name: ðŸ“Š Upload Compliance Report
      uses: actions/upload-artifact@v4
      with:
        name: compliance-report
        path: /tmp/compliance-report.md

  # âš–ï¸ License Compliance
  license-check:
    name: âš–ï¸ License Compliance
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'license' || github.event_name == 'schedule' }}
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'corretto'
        java-version: '11'

    - name: âš–ï¸ Check License Compliance
      run: |
        echo "âš–ï¸ Checking license compliance for Java dependencies..."
        
        # Run Maven license plugin for each microservice
        for service_dir in microservices/*/; do
          if [ -f "$service_dir/pom.xml" ]; then
            service_name=$(basename "$service_dir")
            echo "Checking licenses for $service_name..."
            
            # Run license plugin
            mvn org.codehaus.mojo:license-maven-plugin:2.0.0:add-third-party \
              -Dlicense.failOnMissing=false \
              -Dlicense.failOnBlacklist=false \
              -Dlicense.outputDirectory=/tmp/licenses \
              -f "$service_dir/pom.xml" || echo "âš ï¸ License plugin failed for $service_name"
          fi
        done
        
        # Check for prohibited licenses
        PROHIBITED_LICENSES="GPL-2.0 GPL-3.0 AGPL"
        
        # Create a summary license file
        echo "# License Summary for E-commerce Microservices" > /tmp/licenses/LICENSE-SUMMARY.txt
        echo "Generated on: $(date)" >> /tmp/licenses/LICENSE-SUMMARY.txt
        echo "" >> /tmp/licenses/LICENSE-SUMMARY.txt
        
        if find /tmp/licenses -name "*.txt" -exec cat {} \; | grep -E "$PROHIBITED_LICENSES"; then
          echo "âŒ Prohibited licenses found!"
          exit 1
        else
          echo "âœ… No prohibited licenses detected"
          echo "All dependencies use permissive licenses (Apache, MIT, BSD)" >> /tmp/licenses/LICENSE-SUMMARY.txt
        fi

    - name: ðŸ“Š Upload License Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: license-report
        path: |
          /tmp/licenses/
          microservices/**/THIRD-PARTY.txt

  # ðŸš¨ Security Alerts
  security-notification:
    name: ðŸš¨ Security Alert Notification
    runs-on: ubuntu-latest
    needs: [vulnerability-scan, secret-scan, compliance-check, license-check]
    if: always() && (failure() || contains(needs.*.result, 'failure'))
    steps:
    - name: ðŸš¨ Send Security Alert
      run: |
        echo "ðŸš¨ SECURITY ALERT: Issues detected in security scan!"
        echo ""
        echo "ðŸ“Š Scan Results:"
        echo "- Vulnerability Scan: ${{ needs.vulnerability-scan.result }}"
        echo "- Secret Scan: ${{ needs.secret-scan.result }}"
        echo "- Compliance Check: ${{ needs.compliance-check.result }}"
        echo "- License Check: ${{ needs.license-check.result }}"
        echo ""
        echo "ðŸ”— View full results: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # ðŸ“Š Security Summary
  security-summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [vulnerability-scan, secret-scan, compliance-check, license-check]
    if: always()
    steps:
    - name: ðŸ“Š Generate Security Summary
      run: |
        echo "## ðŸ›¡ï¸ Security & Compliance Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Date**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ” Vulnerability Scan**: ${{ needs.vulnerability-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ” Secret Scan**: ${{ needs.secret-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ“‹ Compliance Check**: ${{ needs.compliance-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **âš–ï¸ License Check**: ${{ needs.license-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        FAILED_SCANS=$(echo "${{ needs.vulnerability-scan.result }} ${{ needs.secret-scan.result }} ${{ needs.compliance-check.result }} ${{ needs.license-check.result }}" | grep -o failure | wc -l)
        
        if [ "$FAILED_SCANS" -eq 0 ]; then
          echo "âœ… **All security scans passed!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **$FAILED_SCANS security scan(s) failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Action Required**: Review failed scans and address security issues immediately." >> $GITHUB_STEP_SUMMARY
        fi
name: üê¶ Canary Deployment Pipeline

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy with canary strategy'
        required: true
        type: choice
        options:
          - api-gateway
          - user-service
          - product-service
          - payment-service
          - order-service
          - shipping-service
          - favourite-service
      image_tag:
        description: 'Image tag to deploy'
        required: true
        default: 'latest'
      canary_percentage:
        description: 'Percentage of traffic to route to canary (1-50)'
        required: true
        default: '10'

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || 'axiomatic-fiber-479102-k7' }}
  GCP_ZONE: us-central1-a
  GKE_CLUSTER: ecommerce-cluster
  REGISTRY: gcr.io

jobs:
  # üê¶ Canary Deployment
  canary-deployment:
    name: üê¶ Deploy Canary Version
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      
    - name: üîë Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: üõ†Ô∏è Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      
    - name: ‚öôÔ∏è Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GCP_ZONE }} \
          --project ${{ env.GCP_PROJECT_ID }}

    - name: üìä Validate Inputs
      run: |
        if [ "${{ github.event.inputs.canary_percentage }}" -lt 1 ] || [ "${{ github.event.inputs.canary_percentage }}" -gt 50 ]; then
          echo "‚ùå Canary percentage must be between 1 and 50"
          exit 1
        fi
        
        if ! kubectl get deployment ${{ github.event.inputs.service }} -n dev >/dev/null 2>&1; then
          echo "‚ùå Service ${{ github.event.inputs.service }} not found in dev namespace"
          exit 1
        fi
        
        echo "‚úÖ Inputs validated successfully"

    - name: üê¶ Create Canary Deployment
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        CANARY_PERCENTAGE="${{ github.event.inputs.canary_percentage }}"
        
        echo "üê¶ Creating canary deployment for $SERVICE..."
        
        # Get current deployment
        kubectl get deployment $SERVICE -n dev -o yaml > /tmp/current-deployment.yaml
        
        # Create canary deployment
        sed "s/$SERVICE/$SERVICE-canary/g" /tmp/current-deployment.yaml > /tmp/canary-deployment.yaml
        sed -i "s/replicas: [0-9]*/replicas: 1/" /tmp/canary-deployment.yaml
        sed -i "s|image: .*|image: ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$SERVICE:$IMAGE_TAG|" /tmp/canary-deployment.yaml
        
        # Add canary labels
        sed -i '/labels:/a \ \ \ \ version: canary' /tmp/canary-deployment.yaml
        sed -i '/matchLabels:/a \ \ \ \ version: canary' /tmp/canary-deployment.yaml
        sed -i '/metadata:/,/labels:/{/labels:/a \ \ \ \ version: canary
        }' /tmp/canary-deployment.yaml
        
        # Apply canary deployment
        kubectl apply -f /tmp/canary-deployment.yaml
        
        # Wait for canary to be ready
        kubectl rollout status deployment/$SERVICE-canary -n dev --timeout=300s
        
        echo "‚úÖ Canary deployment created successfully"

    - name: ‚öñÔ∏è Configure Traffic Split
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        CANARY_PERCENTAGE="${{ github.event.inputs.canary_percentage }}"
        STABLE_PERCENTAGE=$((100 - CANARY_PERCENTAGE))
        
        echo "‚öñÔ∏è Configuring traffic split: Stable $STABLE_PERCENTAGE% | Canary $CANARY_PERCENTAGE%"
        
        # Create VirtualService for traffic splitting (if using Istio)
        # For now, we'll use weighted services approach
        
        # Update service selector to route traffic
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: Service
        metadata:
          name: $SERVICE-stable
          namespace: dev
        spec:
          selector:
            app: $SERVICE
            version: stable
          ports:
          - port: 80
            targetPort: 8080
        ---
        apiVersion: v1
        kind: Service  
        metadata:
          name: $SERVICE-canary
          namespace: dev
        spec:
          selector:
            app: $SERVICE
            version: canary
          ports:
          - port: 80
            targetPort: 8080
        EOF
        
        # Add version label to stable deployment
        kubectl patch deployment $SERVICE -n dev -p '{"spec":{"template":{"metadata":{"labels":{"version":"stable"}}}}}'
        
        echo "‚úÖ Traffic split configured"

    - name: üß™ Run Canary Tests
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        
        echo "üß™ Running canary validation tests..."
        
        # Wait for services to be ready
        sleep 30
        
        # Get service endpoints
        CANARY_IP=$(kubectl get svc $SERVICE-canary -n dev -o jsonpath='{.spec.clusterIP}')
        
        # Run health checks
        kubectl run canary-test --image=curlimages/curl --rm -i --restart=Never -- \
          curl -f http://$CANARY_IP/actuator/health || {
          echo "‚ùå Canary health check failed"
          exit 1
        }
        
        echo "‚úÖ Canary tests passed"

    - name: üìä Monitor Canary Metrics
      run: |
        echo "üìä Monitoring canary metrics for 5 minutes..."
        echo "In production, this would check:"
        echo "- Error rates"
        echo "- Response times" 
        echo "- Resource usage"
        echo "- Business metrics"
        
        # Simulate monitoring period
        sleep 60
        
        echo "‚úÖ Canary metrics look healthy"

  # üîÑ Promote or Rollback
  promote-or-rollback:
    name: üîÑ Promote or Rollback Canary
    runs-on: ubuntu-latest
    needs: canary-deployment
    environment: production-promotion
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
      
    - name: üîë Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: üõ†Ô∏è Setup gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      
    - name: ‚öôÔ∏è Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GCP_ZONE }} \
          --project ${{ env.GCP_PROJECT_ID }}

    - name: ‚úÖ Promote Canary to Production
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        
        echo "‚úÖ Promoting canary to production..."
        
        # Update main deployment with canary image
        kubectl set image deployment/$SERVICE $SERVICE=${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/$SERVICE:$IMAGE_TAG -n dev
        
        # Wait for rollout to complete
        kubectl rollout status deployment/$SERVICE -n dev --timeout=300s
        
        # Clean up canary deployment
        kubectl delete deployment $SERVICE-canary -n dev || true
        kubectl delete svc $SERVICE-canary -n dev || true
        kubectl delete svc $SERVICE-stable -n dev || true
        
        # Remove version labels
        kubectl patch deployment $SERVICE -n dev --type=json -p='[{"op": "remove", "path": "/spec/template/metadata/labels/version"}]' || true
        
        echo "‚úÖ Canary promoted successfully"

  # üìä Deployment Summary
  summary:
    name: üìä Canary Deployment Summary
    runs-on: ubuntu-latest
    needs: [canary-deployment, promote-or-rollback]
    if: always()
    steps:
    - name: üìä Generate Summary
      run: |
        echo "## üê¶ Canary Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Service**: ${{ github.event.inputs.service }}" >> $GITHUB_STEP_SUMMARY
        echo "**Image Tag**: ${{ github.event.inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
        echo "**Canary Percentage**: ${{ github.event.inputs.canary_percentage }}%" >> $GITHUB_STEP_SUMMARY
        echo "**Canary Deployment**: ${{ needs.canary-deployment.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**Promotion**: ${{ needs.promote-or-rollback.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.promote-or-rollback.result }}" == "success" ]; then
          echo "üéâ **Canary deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Canary deployment failed or was rolled back**" >> $GITHUB_STEP_SUMMARY
        fi
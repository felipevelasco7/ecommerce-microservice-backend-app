---
# Default: Denegar todo el tráfico entrante
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: dev
spec:
  podSelector: {}
  policyTypes:
  - Ingress
---
# Permitir tráfico desde API Gateway a todos los microservicios
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-api-gateway
  namespace: dev
spec:
  podSelector:
    matchLabels:
      tier: backend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: proxy-client
---
# Permitir tráfico a PostgreSQL solo desde servicios autorizados
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-allow-backend
  namespace: dev
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: user-service
    - podSelector:
        matchLabels:
          app: product-service
    - podSelector:
        matchLabels:
          app: order-service
    - podSelector:
        matchLabels:
          app: payment-service
    - podSelector:
        matchLabels:
          app: shipping-service
    - podSelector:
        matchLabels:
          app: favourite-service
    ports:
    - protocol: TCP
      port: 5432
---
# Permitir tráfico a Eureka (Service Discovery) desde todos los servicios
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: eureka-allow-all-services
  namespace: dev
spec:
  podSelector:
    matchLabels:
      app: service-discovery
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 8761
---
# Permitir tráfico a Cloud Config desde todos los servicios
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cloud-config-allow-all
  namespace: dev
spec:
  podSelector:
    matchLabels:
      app: cloud-config
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 9296
---
# Permitir tráfico a Zipkin desde todos los servicios
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: zipkin-allow-all
  namespace: dev
spec:
  podSelector:
    matchLabels:
      app: zipkin
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 9411
---
# API Gateway: Permitir tráfico desde el mundo exterior
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-gateway-allow-external
  namespace: dev
spec:
  podSelector:
    matchLabels:
      app: api-gateway
  policyTypes:
  - Ingress
  ingress:
  - {}  # Permitir todo el tráfico entrante
---
# Proxy Client: Permitir tráfico desde el mundo exterior
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: proxy-client-allow-external
  namespace: dev
spec:
  podSelector:
    matchLabels:
      app: proxy-client
  policyTypes:
  - Ingress
  ingress:
  - {}  # Permitir todo el tráfico entrante
---
# User Service: Permitir tráfico desde gateways
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: user-service-allow-gateways
  namespace: dev
spec:
  podSelector:
    matchLabels:
      app: user-service
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: proxy-client
    ports:
    - protocol: TCP
      port: 8700
---
# Product Service: Permitir tráfico desde gateways y order-service
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: product-service-allow-gateways
  namespace: dev
spec:
  podSelector:
    matchLabels:
      app: product-service
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: proxy-client
    - podSelector:
        matchLabels:
          app: order-service
    ports:
    - protocol: TCP
      port: 8800
---
# Order Service: Permitir tráfico desde gateways
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: order-service-allow-gateways
  namespace: dev
spec:
  podSelector:
    matchLabels:
      app: order-service
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: proxy-client
    ports:
    - protocol: TCP
      port: 8600
---
# Payment Service: Permitir tráfico desde gateways y order-service
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: payment-service-allow-gateways
  namespace: dev
spec:
  podSelector:
    matchLabels:
      app: payment-service
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: proxy-client
    - podSelector:
        matchLabels:
          app: order-service
    ports:
    - protocol: TCP
      port: 8500
---
# Shipping Service: Permitir tráfico desde gateways y order-service
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: shipping-service-allow-gateways
  namespace: dev
spec:
  podSelector:
    matchLabels:
      app: shipping-service
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: proxy-client
    - podSelector:
        matchLabels:
          app: order-service
    ports:
    - protocol: TCP
      port: 8400
---
# Favourite Service: Permitir tráfico desde gateways
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: favourite-service-allow-gateways
  namespace: dev
spec:
  podSelector:
    matchLabels:
      app: favourite-service
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api-gateway
    - podSelector:
        matchLabels:
          app: proxy-client
    ports:
    - protocol: TCP
      port: 8300
---
# Permitir tráfico desde Prometheus a todos los pods con métricas
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-scraping
  namespace: dev
spec:
  podSelector:
    matchExpressions:
    - key: app
      operator: In
      values:
      - user-service
      - product-service
      - order-service
      - payment-service
      - shipping-service
      - favourite-service
      - api-gateway
      - proxy-client
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
      podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 8100
    - protocol: TCP
      port: 8200
    - protocol: TCP
      port: 8300
    - protocol: TCP
      port: 8400
    - protocol: TCP
      port: 8500
    - protocol: TCP
      port: 8600
    - protocol: TCP
      port: 8700
    - protocol: TCP
      port: 8800

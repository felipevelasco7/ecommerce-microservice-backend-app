apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: logging
data:
  config.yml: |
    server:
      http_listen_port: 3101
      grpc_listen_port: 0

    positions:
      filename: /tmp/positions.yaml

    clients:
      - url: http://loki:3100/loki/api/v1/push

    scrape_configs:
      # Microservices logs
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
        pipeline_stages:
          - docker: {}
        relabel_configs:
          - source_labels:
              - __meta_kubernetes_pod_controller_name
            regex: ([0-9a-z-.]+?)(-[0-9a-f]{8,10})?
            action: replace
            target_label: __tmp_controller_name
          - source_labels:
              - __meta_kubernetes_pod_label_app
            action: replace
            target_label: app
          - source_labels:
              - __meta_kubernetes_pod_label_component
            action: replace
            target_label: component
          - source_labels:
              - __meta_kubernetes_pod_node_name
            action: replace
            target_label: node_name
          - source_labels:
              - __meta_kubernetes_namespace
            action: replace
            target_label: namespace
          - source_labels:
              - __meta_kubernetes_pod_name
            action: replace
            target_label: pod_name
          - source_labels:
              - __meta_kubernetes_pod_container_name
            action: replace
            target_label: container_name
          - source_labels:
              - __meta_kubernetes_pod_label_version
            action: replace
            target_label: version
          - action: labelmap
            regex: __meta_kubernetes_pod_annotation_prometheus_io_(.+)

      # Spring Boot application logs (specific to our microservices)
      - job_name: spring-boot-logs
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: [dev, prod, staging]
        pipeline_stages:
          - match:
              selector: '{app=~".*service.*"}'
              stages:
                - regex:
                    expression: '(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3})\s+(?P<level>\w+)\s+(?P<thread>\[.*?\])\s+(?P<logger>[^\s]+)\s*:\s*(?P<message>.*)'
                - timestamp:
                    source: timestamp
                    format: '2006-01-02 15:04:05.000'
                - labels:
                    level: level
                    thread: thread
                    logger: logger
        relabel_configs:
          - source_labels:
              - __meta_kubernetes_pod_label_app
            regex: '(api-gateway|user-service|product-service|order-service|payment-service|shipping-service|favourite-service|cloud-config|service-discovery|proxy-client)'
            action: keep
          - source_labels:
              - __meta_kubernetes_pod_label_app
            action: replace
            target_label: service
          - source_labels:
              - __meta_kubernetes_namespace
            action: replace
            target_label: namespace
          - source_labels:
              - __meta_kubernetes_pod_name
            action: replace
            target_label: pod

      # Nginx/Ingress logs
      - job_name: nginx-ingress
        kubernetes_sd_configs:
          - role: pod
        pipeline_stages:
          - match:
              selector: '{app="ingress-nginx"}'
              stages:
                - regex:
                    expression: '(?P<remote_addr>\d+\.\d+\.\d+\.\d+) - (?P<remote_user>[^ ]*) \[(?P<time_local>[^\]]*)\] "(?P<method>\S+)(?: +(?P<path>[^\"]*?)(?: +\S*)?)?" (?P<status>[^ ]*) (?P<body_bytes_sent>[^ ]*) "(?P<http_referer>[^\"]*)" "(?P<http_user_agent>[^\"]*)" (?P<request_length>[^ ]*) (?P<request_time>[^ ]*) \[(?P<proxy_upstream_name>[^ ]*)\] \[(?P<proxy_alternative_upstream_name>[^ ]*)\] (?P<upstream_addr>[^ ]*) (?P<upstream_response_length>[^ ]*) (?P<upstream_response_time>[^ ]*) (?P<upstream_status>[^ ]*) (?P<req_id>[^ ]*)'
                - labels:
                    method: method
                    status: status
                    upstream_service: proxy_upstream_name
        relabel_configs:
          - source_labels:
              - __meta_kubernetes_pod_label_app_kubernetes_io_name
            regex: ingress-nginx
            action: keep

      # Database logs (PostgreSQL)
      - job_name: postgresql
        kubernetes_sd_configs:
          - role: pod
        pipeline_stages:
          - match:
              selector: '{app="postgres"}'
              stages:
                - regex:
                    expression: '(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3} \w{3}) \[(?P<process_id>\d+)\] (?P<level>\w+):\s*(?P<message>.*)'
                - timestamp:
                    source: timestamp
                    format: '2006-01-02 15:04:05.000 MST'
                - labels:
                    level: level
                    process_id: process_id
        relabel_configs:
          - source_labels:
              - __meta_kubernetes_pod_label_app
            regex: postgres
            action: keep
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: promtail
  namespace: logging
  labels:
    app: promtail
spec:
  selector:
    matchLabels:
      app: promtail
  template:
    metadata:
      labels:
        app: promtail
    spec:
      serviceAccount: promtail
      containers:
      - name: promtail
        image: grafana/promtail:2.9.0
        imagePullPolicy: IfNotPresent
        args:
        - -config.file=/etc/promtail/config.yml
        - -config.expand-env=true
        env:
        - name: HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        volumeMounts:
        - name: config
          mountPath: /etc/promtail
        - name: run
          mountPath: /run/promtail
        - mountPath: /var/lib/docker/containers
          name: containers
          readOnly: true
        - mountPath: /var/log/pods
          name: pods
          readOnly: true
        - mountPath: /var/log/journal
          name: journal
          readOnly: true
        ports:
        - name: http-metrics
          containerPort: 3101
          protocol: TCP
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /ready
            port: http-metrics
          initialDelaySeconds: 10
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          failureThreshold: 5
          httpGet:
            path: /ready
            port: http-metrics
          initialDelaySeconds: 10
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi
        securityContext:
          privileged: true
          runAsUser: 0
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/master
        operator: Exists
      - effect: NoSchedule
        key: node-role.kubernetes.io/control-plane
        operator: Exists
      volumes:
      - name: config
        configMap:
          name: promtail-config
      - name: run
        hostPath:
          path: /run/promtail
      - name: containers
        hostPath:
          path: /var/lib/docker/containers
      - name: pods
        hostPath:
          path: /var/log/pods
      - name: journal
        hostPath:
          path: /var/log/journal
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: promtail
  namespace: logging
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: promtail
rules:
- apiGroups:
  - ""
  resources:
  - nodes
  - nodes/proxy
  - services
  - endpoints
  - pods
  verbs:
  - get
  - watch
  - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: promtail
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: promtail
subjects:
- kind: ServiceAccount
  name: promtail
  namespace: logging
---
apiVersion: v1
kind: Service
metadata:
  name: promtail
  namespace: logging
  labels:
    app: promtail
spec:
  clusterIP: None
  selector:
    app: promtail
  ports:
  - name: http-metrics
    port: 3101
    protocol: TCP
    targetPort: http-metrics